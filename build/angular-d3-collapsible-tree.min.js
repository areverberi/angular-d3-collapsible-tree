"use strict";function collapsibleTree(){return{restrict:"E",scope:{width:"=",height:"=",radius:"=",nodes:"=",onNodeClick:"&",images:"="},link:function(a,b){function c(b){function f(a,b){console.log(a,"text"),a.each(function(){var a,c=d3.select(this),d=c.text().split(/\s+/).reverse(),e=[],f=0,g=20,h=c.attr("y"),i=parseFloat(c.attr("dy"));if(d.length>1)for(var j=c.text(null).append("tspan").attr("x",0).attr("y",h).attr("dy",i+"px");a=d.pop();)e.push(a),j.text(e.join(" ")),j.node().getComputedTextLength()>b&&(e.pop(),j.text(e.join(" ")),e=[a],j=0===f?c.append("tspan").attr("x",0).attr("y",h).attr("dy",g+"px").text(a):c.append("tspan").attr("x",0).attr("y",h).attr("dy",g+"px").text(a))})}var g=a.width/a.radius||18,h=d3.event&&d3.event.altKey?5e3:500,m=[1],n=function(a,b){b.children&&b.children.length>0&&(m.length<=a+1&&m.push(0),m[a+1]+=b.children.length,b.children.forEach(function(b){n(a+1,b)}))};n(0,e);var p=d3.max(m)*a.width*.2,q=0,r=function(a){return a.children&&0!==a.children.length?1+d3.max(a.children.map(r)):1};q=r(e);var s=q*a.width*.25;j=j.size([p,s]),l.attr("height",p+.1*a.width),l.attr("width",s+.1*a.width);var t=j.nodes(e).reverse();t.forEach(function(b){b.y=b.depth*a.width*.225});var u=o.selectAll("g.node").data(t,function(a){return a.id||(a.id=++i)}),v=u.enter().append("svg:g").attr("class","node").attr("transform",function(a){return"translate("+b.y0+","+b.x0+")"}).on("click",function(b){d(b),a.onNodeClick&&a.onNodeClick({id:b.id}),c(b)});v.append("svg:circle").attr("r",1e-5).style("fill",function(b){return a.images&&b.name?(console.info("d",b),console.info("url(#"+b.name.replace(/\s/g,"")+")"),"url(#"+b.name.replace(/\s/g,"")+")"):b._children?"lightsteelblue":"#fff"}),v.append("svg:text").attr("dy",""+(2*g+.0125*a.width)).attr("text-anchor",function(a){return"middle"}).text(function(a){return a.name}).style("fill-opacity",1e-5);var w=u.transition().duration(h).attr("transform",function(a){return"translate("+a.y+","+a.x+")"});w.select("circle").attr("r",g).style("fill",function(b){return a.images&&b.name?(console.info("url(#"+b.name.replace(/\s/g,"")+")"),"url(#"+b.name.replace(/\s/g,"")+")"):b._children?"lightsteelblue":"#fff"}),w.select("text").style("fill-opacity",1).call(f,2*g+.0125*a.width);var x=u.exit().transition().duration(h).attr("transform",function(a){return"translate("+b.y+","+b.x+")"}).remove();x.select("circle").attr("r",1e-6),x.select("text").style("fill-opacity",1e-6);var y=o.selectAll("path.link").data(j.links(t),function(a){return a.target.id});y.enter().insert("svg:path","g").attr("class","link").attr("d",function(a){var c={x:b.x0,y:b.y0};return k({source:c,target:c})}).transition().duration(h).attr("d",k),y.transition().duration(h).attr("d",k),y.exit().transition().duration(h).attr("d",function(a){var c={x:b.x,y:b.y};return k({source:c,target:c})}).remove(),t.forEach(function(a){a.x0=a.x,a.y0=a.y})}function d(a){a.children?(a._children=a.children,a.children=null):(a.children=a._children,a._children=null)}var e,f=[.025*a.width,120,.025*a.width,120],g=1280-f[1]-f[3],h=800-f[0]-f[2],i=0,j=d3.layout.tree().size([h,g]),k=d3.svg.diagonal().projection(function(a){return[a.y,a.x]}),l=d3.select("collapsible-tree").append("svg:svg"),m=l;if(a.images){m=l.append("svg:defs");for(var n in a.images)m.append("svg:pattern").attr("id",n).attr("patternContentUnits","objectBoundingBox").attr("width",1).attr("height",1).append("svg:image").attr("xlink:href",a.images[n]).attr("x",0).attr("y",0).attr("width",1).attr("height",1).attr("preserveAspectRatio","xMinYMin slice")}var o=m.append("svg:g").attr("transform","translate("+f[3]+","+f[0]+")");a.$watch("nodes",function(){function b(a){a.children&&(a.children.forEach(b),d(a))}a.nodes&&(e=angular.copy(a.nodes),e.x0=h/2,e.y0=0,e.children&&e.children.forEach(b),c(e))},!0)}}}var app=angular.module("renderteam.collapsibleTree",[]);app.directive("collapsibleTree",collapsibleTree),collapsibleTree.$inject=[];